<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Іба Чотко — Офіційний мем-сайт (Ультра-дизайн і повна біографія)</title>
  <meta name="description" content="Фан-сайт персонажа «Іба Чотко»: великий опис, мем-студія, TTS, завантаження логотипа (drag&drop/paste), адаптивний дизайн для телефону." />
  <meta name="author" content="Головнін В.С." />
  <style>
    /* ===========================
       Ультра-дизайн (темна мем-естетика)
       =========================== */
    :root{
      --bg-1: #030417;
      --bg-2: #07112a;
      --card: rgba(255,255,255,0.03);
      --accent-1: #ff3b6b;
      --accent-2: #ffd23f;
      --muted: rgba(255,255,255,0.78);
      --glass: rgba(255,255,255,0.03);
      --radius: 14px;
      --neon: 0 12px 50px rgba(255,59,107,0.14);
      --max-width: 1100px;
      font-family: Inter, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:
      radial-gradient(600px 280px at 8% 12%, rgba(255,59,107,0.04), transparent 8%),
      radial-gradient(500px 200px at 90% 88%, rgba(255,210,63,0.02), transparent 10%),
      linear-gradient(180deg,var(--bg-1),var(--bg-2));
      color:#fff;}
    a{color:inherit}
    .wrap{max-width:var(--max-width);margin:18px auto;padding:0 18px}

    /* Header */
    header{position:sticky;top:12px;z-index:80;margin-bottom:8px}
    .header{
      display:flex;align-items:center;gap:16px;padding:12px;border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      border:1px solid var(--card);box-shadow:var(--neon)
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo-area{width:88px;height:88px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);border:2px dashed rgba(255,255,255,0.02);position:relative;cursor:pointer}
    .logo-area img{width:100%;height:100%;object-fit:cover;display:block}
    .logo-overlay{position:absolute;inset:auto 6px 6px 6px;padding:4px 6px;border-radius:8px;background:rgba(0,0,0,0.38);font-weight:800;color:var(--accent-2);font-size:12px}
    .brand-name{display:flex;flex-direction:column}
    .brand-name .title{font-size:18px;font-weight:900;color:var(--accent-1)}
    .brand-name .sub{font-size:12px;color:var(--muted)}

    /* Tabs + header actions */
    .tabs{display:flex;gap:8px;margin-left:14px}
    .tab{padding:8px 12px;border-radius:10px;background:transparent;color:var(--muted);cursor:pointer;font-weight:800}
    .tab[aria-selected="true"]{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#081018;box-shadow:var(--neon)}
    .header-actions{margin-left:auto;display:flex;gap:10px;align-items:center}

    /* Main cards */
    main{margin-top:14px}
    .card{border-radius:12px;padding:16px;border:1px solid var(--card);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));margin-bottom:16px}
    h1,h2,h3{margin:0 0 10px 0}
    h1{font-size:28px;color:var(--accent-1)}
    .lead{color:var(--muted);line-height:1.5}

    /* Studio layout */
    .studio{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
    .meme-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
    .meme-item{padding:12px;border-radius:10px;text-align:center;cursor:pointer;border:1px dashed rgba(255,255,255,0.03);transition:transform .15s ease,box-shadow .15s ease;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent)}
    .meme-item:hover{transform:translateY(-6px);box-shadow:0 12px 34px rgba(0,0,0,0.6)}

    /* uploader and previews */
    .uploader{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .preview{width:140px;height:140px;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02)}
    .preview img{max-width:100%;max-height:100%;display:block}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}

    /* Bio long read */
    .bio-full{max-height:72vh;overflow:auto;padding-right:8px}
    .bio-section{margin-bottom:12px;color:var(--muted);line-height:1.6}

    /* footer */
    footer{position:fixed;left:12px;right:12px;bottom:12px;padding:10px 14px;border-radius:12px;border:1px solid var(--card);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.38));backdrop-filter:blur(6px)}
    .small{font-size:13px;color:var(--muted)}

    /* responsive */
    @media (max-width:980px){
      .studio{grid-template-columns:1fr}
      .logo-area{width:64px;height:64px}
      .brand-name .title{font-size:16px}
      .tabs{display:none}
      .header{flex-direction:column;align-items:flex-start;gap:12px}
    }

    /* focus */
    button:focus, input:focus, [role="tab"]:focus{outline:3px solid rgba(255,210,63,0.14);outline-offset:3px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header>
      <div class="header">
        <div class="brand" aria-hidden="false">
          <div id="logoArea" class="logo-area" tabindex="0" title="Натисни або перетягни/встав зображення — встановити логотип">
            <!-- default placeholder; will be replaced with <img> when a logo is set -->
            <div id="logoPlaceholder" style="text-align:center;padding:8px">
              <svg width="56" height="56" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs><linearGradient id="lg1" x1="0" x2="1"><stop offset="0" stop-color="#ff3b6b"/><stop offset="1" stop-color="#ffd23f"/></linearGradient></defs>
                <rect width="100%" height="100%" rx="20" fill="url(#lg1)"/>
                <text x="50%" y="54%" text-anchor="middle" fill="#081018" font-weight="800" font-size="34">Іба</text>
              </svg>
            </div>
            <div class="logo-overlay" id="logoLabel">Логотип</div>
          </div>

          <div class="brand-name">
            <div class="title">Іба Чотко — Офіційний мем-сайт</div>
            <div class="sub">Фан-проєкт • Творець: Головнін В.С.</div>
          </div>
        </div>

        <nav class="tabs" role="tablist" aria-label="Головне меню">
          <div class="tab" role="tab" aria-selected="true" data-target="homePanel" tabindex="0">Головна</div>
          <div class="tab" role="tab" aria-selected="false" data-target="studioPanel" tabindex="0">Мем-студія</div>
          <div class="tab" role="tab" aria-selected="false" data-target="bioPanel" tabindex="0">Велика біографія</div>
          <div class="tab" role="tab" aria-selected="false" data-target="creatorPanel" tabindex="0">Творець</div>
        </nav>

        <div class="header-actions" role="toolbar" aria-label="Дії">
          <button id="pasteHint" class="btn" title="Вставити (Ctrl+V) зображення у логотип">Paste → logo</button>
          <button id="downloadZip" class="btn" title="Завантажити окремі файли (готово для GitHub Pages)">Експорт ZIP</button>
          <button id="themeBtn" class="btn" title="Перемкнути тему">Тема</button>
        </div>
      </div>
    </header>

    <!-- Main content panels -->
    <main>
      <!-- HOME -->
      <section id="homePanel" class="card" role="tabpanel" aria-labelledby="homeTab" style="display:block">
        <h1>Вітаю у всесвіті «Іба Чотко»</h1>
        <p class="lead">Це офіційний фан-сайт, присвячений мем-персонажу «Іба Чотко». Тут — детальна біографія, потужна мем-студія, голосовий синтез (TTS), можливість встановити твоє зображення як логотип і багато іншого. Сайт повністю адаптовано для мобільних пристроїв.</p>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
          <button id="playIbaMain" class="btn strong" title="Проговорити фразу">Проговорити: «Іба чотко!»</button>
          <button id="openStudio" class="btn" title="Перейти в мем-студію">Відкрити Мем-студію</button>
          <button id="openBio" class="btn" title="Перейти в розділ біографії">Читати біографію</button>
        </div>
      </section>

      <!-- STUDIO -->
      <section id="studioPanel" class="card" role="tabpanel" aria-labelledby="studioTab" style="display:none">
        <h2>Мем-студія — створюй власні меми</h2>

        <div class="studio" aria-live="polite">
          <div>
            <div class="card">
              <h3>Колекція фраз</h3>
              <div id="memeGrid" class="meme-grid" role="list" aria-label="Колекція мем-фраз">
                <!-- JS наповнить плитки -->
              </div>
              <div class="muted" style="margin-top:8px">Клацни плитку — фраза програється. Подвійний клік на сітці — додати власну фразу.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Власні фрази</h3>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <input id="newPhrase" class="input" placeholder="Введи нову фразу..." style="min-width:220px">
                <button id="addPhraseBtn" class="btn">Додати</button>
                <button id="clearUserPhrases" class="btn">Очистити користувацькі</button>
              </div>
              <div class="muted" style="margin-top:8px">Фрази зберігаються локально — їх можна завжди відновити у налаштуваннях.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>TTS — голосовий синтез</h3>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <label class="muted">Голос</label>
                <select id="voiceSelect" class="input" aria-label="Вибір голосу"></select>
                <label class="muted">Швидкість</label>
                <input id="rate" type="range" min="0.6" max="1.6" step="0.1" value="1">
                <button id="playRandom" class="btn">Програти випадкову</button>
              </div>
              <div class="muted" style="margin-top:8px">Найкраща підтримка у Chrome/Edge. Якщо голоси не знайдені — відобразиться фолбек.</div>
            </div>

          </div>

          <aside>
            <div class="card">
              <h3>Завантаження фото персонажа</h3>
              <div class="uploader">
                <div id="imagePreview" class="preview" title="Перетягни сюди або встав фото (Ctrl+V)"></div>
                <div style="display:flex;flex-direction:column;gap:8px">
                  <label for="imageInput" class="btn" style="cursor:pointer">Обрати фото</label>
                  <input id="imageInput" type="file" accept="image/*" style="display:none">
                  <button id="setLogoFromImage" class="btn">Встановити як логотип</button>
                  <button id="useImageInMeme" class="btn">Використати у наступному мемі</button>
                </div>
              </div>

              <hr style="opacity:0.06;margin:12px 0">

              <h3>Генератор мемів</h3>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <input id="topText" class="input" placeholder="Текст зверху" style="min-width:150px">
                <input id="bottomText" class="input" placeholder="Текст знизу" style="min-width:150px">
                <button id="generateMemeBtn" class="btn strong">Згенерувати</button>
              </div>
              <div style="margin-top:8px" class="muted">Після генерації — попередній перегляд, а також кнопки для завантаження/відкриття.</div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>Останній мем</h3>
              <div id="lastMemePreview" class="preview" style="height:180px"></div>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="downloadMeme" class="btn">Завантажити PNG</button>
                <button id="openMeme" class="btn">Відкрити у вкладці</button>
              </div>
            </div>
          </aside>
        </div>
      </section>

      <!-- BIO -->
      <section id="bioPanel" class="card" role="tabpanel" aria-labelledby="bioTab" style="display:none">
        <h2>Велика біографія персонажа «Іба Чотко»</h2>
        <div class="bio-full" tabindex="0" aria-label="Повна біографія персонажа">
          <!-- Rich, long biography content -->
          <article class="bio-section">
            <h3>1. Походження і перші кадри</h3>
            <p>Персонаж, який пізніше отримав фанатський титул «Іба Чотко», з'явився в кадрі популярного анімаційного епізоду — нестандартна міміка і коротка репліка стали причиною швидкого поширення в інтернет-культурах. Спочатку це був просто смішний епізод, але меми трансформували контекст фрази у щось більше, ніж жарт: фраза стала способом сказати «все зрозуміло й зроблено правильно» одним словом.</p>
          </article>

          <article class="bio-section">
            <h3>2. Характер і архетип</h3>
            <p>Іба Чотко — це архетип нетерплячого, впевненого в собі персонажа з легкою щіпкою сарказму. Його сила в одночасній простоті та багатозначності: «Іба чотко» може бути схваленням плану, іронічною відмовою або емоційним підсумком ситуації. У мем-культурі такі фрази швидко набувають власного життя — автори реміксів додають музику, звукові семпли і спліт-нарізки, створюючи окремий пласт фан-контенту.</p>
          </article>

          <article class="bio-section">
            <h3>3. Еволюція як мем</h3>
            <p>З моменту першого розповсюдження мем почав розгалужуватися: створилися окремі аудіосемпли, реакції, гіфки та відео-ремікси. У соціальних мережах почали з'являтися жартівливі сторінки та спільноти, які використовують образ персонажа як символ рішучості та простоти. Меми часто працюють як культурні ярлики — декілька слів відразу передають настрої та конструюють контекст без довгих пояснень.</p>
          </article>

          <article class="bio-section">
            <h3>4. Фан-конвенції та творчість</h3>
            <p>Фан-арт та ремікси — основа живої спільноти. Люди малюють альтернативні інтерпретації персонажа, створюють ігрові спіни, використовують його у стікерах та пакетах мемів для месенджерів. Сайт і мем-студія покликані дати фанам інструменти: згенерувати картинку, озвучити фразу, поділитися творінням і зберегти улюблені репліки.</p>
          </article>

          <article class="bio-section">
            <h3>5. Символізм та культурний контекст</h3>
            <p>Меми — це не лише жарти. Вони часто виконують роль коротких культурних маркерів: дозволяють людям спілкуватись швидко, передавати емоції та створювати колективні жарти. «Іба Чотко» — типовий приклад: зрозуміла, проста фраза, що швидко розповсюджується і набуває багатьох інтерпретацій. На цьому сайті ми не нав'язуємо офіційного канону — лише зберігаємо фольклор інтернет-спільноти.</p>
          </article>

          <article class="bio-section">
            <h3>6. Етика використання зображень</h3>
            <p>Цей сайт — фан-проєкт. Якщо у тебе є офіційні матеріали чи ти власник оригінального контенту, зв'яжись із творцем (Головнін В.С.) для узгодження використання. Ми також даємо інструменти, щоб використовувати власні фото (drag&drop / paste), не порушуючи прав третіх осіб.</p>
          </article>

          <article class="bio-section">
            <h3>7. Майбутнє та розвиток</h3>
            <p>Ми плануємо додавати функції: пакети стікерів, зручні шаблони для соціальних мереж, API для інтеграцій, підтримка коротких відео та автоматичні ремікс-фільтри. Якщо у тебе є ідеї — пропонуй, а також зберігай улюблені фрази прямо в мем-студії.</p>
          </article>
        </div>
      </section>

      <!-- CREATOR -->
      <section id="creatorPanel" class="card" role="tabpanel" aria-labelledby="creatorTab" style="display:none">
        <h2>Творець сайту</h2>
        <p class="lead">Це фан-проєкт, зібраний і підтримуваний Головніним В.С. — сам сайт створено з чистим ентузіазмом, щоб надати простір для творчості та об'єднати фанів мему.</p>
        <div style="display:flex;gap:12px;align-items:center;margin-top:12px;flex-wrap:wrap">
          <div style="min-width:120px">
            <strong>Підпис:</strong>
            <div class="muted">Головнін В.С.</div>
          </div>
          <div>
            <strong>Примітка:</strong>
            <div class="muted">Якщо ти правовласник оригінального контенту — будь ласка, звернись щоб погодити використання матеріалів.</div>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer role="contentinfo">
      <div class="small">© <span id="year"></span> Іба Чотко — Фан-сайт. Творець: Головнін В.С.</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="copyUrlBtn" class="btn">Копіювати URL</button>
        <a id="tweetShare" class="btn" href="#" target="_blank" rel="noopener">Поділитись</a>
      </div>
    </footer>
  </div>

  <!-- Hidden canvas for meme generation -->
  <canvas id="memeCanvas" width="1200" height="1200" style="display:none"></canvas>

  <script>
    /*
      Усе працює у одному файлі:
      - таби (підтримка клавіш)
      - drag&drop/paste/file для логотипа та для фото мему
      - TTS з вибором голосу та швидкістю
      - мем-генератор з canvas (чекає завантаження зображень)
      - збереження логотипа та користувацьких фраз у localStorage
      - адаптивний дизайн для мобільних
      - клавіатурні шорткати: Space -> "Іба чотко!", G -> перейти у мем-студію + згенерувати, L -> фокус логотип
    */

    (function(){
      // Basic refs
      const tabs = Array.from(document.querySelectorAll('.tab'));
      const panels = {
        home: document.getElementById('homePanel'),
        studio: document.getElementById('studioPanel'),
        bio: document.getElementById('bioPanel'),
        creator: document.getElementById('creatorPanel')
      };
      const logoArea = document.getElementById('logoArea');
      const logoLabel = document.getElementById('logoLabel');
      const logoPlaceholder = document.getElementById('logoPlaceholder');
      const pasteHint = document.getElementById('pasteHint');
      const downloadZipBtn = document.getElementById('downloadZip');
      const themeBtn = document.getElementById('themeBtn');

      // Home actions
      document.getElementById('playIbaMain').addEventListener('click', ()=> speak('Іба чотко!'));
      document.getElementById('openStudio').addEventListener('click', ()=> activateTab('studio'));
      document.getElementById('openBio').addEventListener('click', ()=> activateTab('bio'));

      // Meme studio refs
      const memeGrid = document.getElementById('memeGrid');
      const newPhraseInput = document.getElementById('newPhrase');
      const addPhraseBtn = document.getElementById('addPhraseBtn');
      const clearUserPhrases = document.getElementById('clearUserPhrases');
      const voiceSelect = document.getElementById('voiceSelect');
      const rateInput = document.getElementById('rate');
      const playRandomBtn = document.getElementById('playRandom');

      // Upload & meme
      const imageInput = document.getElementById('imageInput');
      const imagePreview = document.getElementById('imagePreview');
      const setLogoFromImageBtn = document.getElementById('setLogoFromImage');
      const useImageInMemeBtn = document.getElementById('useImageInMeme');
      const generateMemeBtn = document.getElementById('generateMemeBtn');
      const topTextInput = document.getElementById('topText');
      const bottomTextInput = document.getElementById('bottomText');
      const lastMemePreview = document.getElementById('lastMemePreview');
      const downloadMemeBtn = document.getElementById('downloadMeme');
      const openMemeBtn = document.getElementById('openMeme');

      // Other
      const copyUrlBtn = document.getElementById('copyUrlBtn');
      const tweetShare = document.getElementById('tweetShare');
      const yearEl = document.getElementById('year');
      yearEl.textContent = new Date().getFullYear();

      // Canvas
      const canvas = document.getElementById('memeCanvas');
      const ctx = canvas.getContext('2d');

      // State
      let storedLogoDataUrl = localStorage.getItem('iba_logo') || null;
      let uploadedImage = null; // Image object for meme generation
      let lastMemeDataUrl = null;
      let userPhrases = JSON.parse(localStorage.getItem('iba_user_phrases') || '[]');

      // Default phrases
      let phrases = [
        "Іба чотко!",
        "Чотко і без компромісів",
        "Коли все ясно — іба чотко",
        "Звучить як план: іба чотко",
        "Прокачай на 100%: іба чотко",
        "Котрий раз говорю — іба чотко!"
      ];
      // prepend user phrases if any
      if (userPhrases.length) phrases = userPhrases.concat(phrases);

      // -- Tabs logic --
      function activateTab(name){
        // name can be key of panels
        Object.keys(panels).forEach(k => {
          panels[k].style.display = (k === name) ? 'block' : 'none';
        });
        tabs.forEach(t => {
          t.setAttribute('aria-selected', (t.dataset.target && t.dataset.target.startsWith(name)) || t.dataset.target === name ? 'true' : 'false');
        });
        // scroll to top of panel on mobile
        panels[name].scrollIntoView({behavior:'smooth', block:'start'});
      }
      tabs.forEach(t => {
        t.addEventListener('click', ()=> activateTab(t.dataset.target.replace('Panel','').toLowerCase()));
        t.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); t.click(); }
        });
      });

      // -- Logo handling: load from localStorage if present --
      function renderLogo(){
        logoArea.innerHTML = ''; // clear
        if (storedLogoDataUrl){
          const img = document.createElement('img');
          img.src = storedLogoDataUrl;
          img.alt = 'Логотип Іба Чотко';
          logoArea.appendChild(img);
          const overlay = document.createElement('div');
          overlay.className = 'logo-overlay';
          overlay.id = 'logoLabel';
          overlay.textContent = 'Логотип';
          logoArea.appendChild(overlay);
        } else {
          // restore placeholder
          logoArea.appendChild(logoPlaceholder);
          const overlay = document.createElement('div');
          overlay.className = 'logo-overlay';
          overlay.id = 'logoLabel';
          overlay.textContent = 'Логотип';
          logoArea.appendChild(overlay);
        }
      }
      renderLogo();

      // click on logoArea -> open file dialog for logo (reusing imageInput)
      logoArea.addEventListener('click', ()=> {
        // reuse hidden imageInput to choose file
        imageInput.click();
      });

      // drag & drop on logoArea
      logoArea.addEventListener('dragover', e => { e.preventDefault(); logoArea.style.opacity = 0.9; });
      logoArea.addEventListener('dragleave', e => { logoArea.style.opacity = 1; });
      logoArea.addEventListener('drop', e => {
        e.preventDefault(); logoArea.style.opacity = 1;
        const f = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]);
        if (f && f.type && f.type.startsWith('image/')) {
          const r = new FileReader();
          r.onload = () => {
            storedLogoDataUrl = r.result;
            try { localStorage.setItem('iba_logo', storedLogoDataUrl); } catch(e) { console.warn('Cannot save logo', e); }
            renderLogo();
            alert('Логотип встановлено.');
          };
          r.readAsDataURL(f);
        } else {
          alert('Перетягни зображення (jpg/png/webp...).');
        }
      });

      // paste support for images: Ctrl+V anywhere -> offer to set as logo or preview for meme
      window.addEventListener('paste', e => {
        const items = (e.clipboardData && e.clipboardData.items) || [];
        for (let it of items){
          if (it.type && it.type.startsWith('image/')){
            const blob = it.getAsFile();
            const r = new FileReader();
            r.onload = () => {
              // show prompt: set as logo or use as meme image
              const dataUrl = r.result;
              if (confirm('Вставлене зображення знайдено. Встановити як логотип? (Натисни "Скасувати" щоб тільки попередньо переглянути)')) {
                storedLogoDataUrl = dataUrl;
                try { localStorage.setItem('iba_logo', storedLogoDataUrl); } catch(e) { console.warn('Cannot save logo', e); }
                renderLogo();
                alert('Логотип встановлено.');
              } else {
                // preview as uploadedImage for meme
                const img = new Image();
                img.onload = () => {
                  uploadedImage = img;
                  imagePreview.innerHTML = '';
                  const el = document.createElement('img'); el.src = dataUrl; imagePreview.appendChild(el);
                  alert('Зображення готове для використання у мемі.');
                };
                img.src = dataUrl;
              }
            };
            r.readAsDataURL(blob);
            return;
          }
        }
      });

      // imageInput: choose file for preview or logo
      imageInput.addEventListener('change', e => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        if (!f.type.startsWith('image/')) return alert('Виберіть файл зображення.');
        const url = URL.createObjectURL(f);
        const img = new Image();
        img.onload = () => {
          uploadedImage = img;
          imagePreview.innerHTML = '';
          const el = document.createElement('img'); el.src = url; imagePreview.appendChild(el);
        };
        img.onerror = () => alert('Не вдалося прочитати файл.');
        img.src = url;
      });

      // setLogoFromImageBtn: use uploadedImage as logo
      setLogoFromImageBtn.addEventListener('click', () => {
        if (!uploadedImage) return alert('Спочатку оберіть фото для попереднього перегляду.');
        const tmp = document.createElement('canvas');
        tmp.width = uploadedImage.width;
        tmp.height = uploadedImage.height;
        const tctx = tmp.getContext('2d');
        tctx.drawImage(uploadedImage, 0, 0);
        try {
          const dataUrl = tmp.toDataURL('image/png');
          storedLogoDataUrl = dataUrl;
          localStorage.setItem('iba_logo', dataUrl);
          renderLogo();
          alert('Логотип збережений локально.');
        } catch(e) {
          alert('Не вдалось зберегти логотип — можлива політика браузера щодо localStorage великого обсягу.');
        }
      });

      // useImageInMemeBtn: just confirm that uploadedImage will be used for next meme generation
      useImageInMemeBtn.addEventListener('click', () => {
        if (!uploadedImage) return alert('Спочатку обери фото.');
        alert('Зображення буде використано у наступній генерації мему.');
      });

      // -- Phrases grid --
      function populatePhrasesGrid(){
        memeGrid.innerHTML = '';
        const used = new Set();
        const total = Math.min(12, Math.max(6, phrases.length));
        for (let i=0;i<total;i++){
          let idx;
          do { idx = Math.floor(Math.random()*phrases.length); } while (used.has(idx) && used.size < phrases.length);
          used.add(idx);
          const text = phrases[idx];
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'meme-item';
          btn.innerHTML = `<div style="font-weight:900;color:var(--accent-1);font-size:15px;margin-bottom:6px">${escapeHtml(text)}</div><div style="font-size:12px;color:var(--muted)">Натисни — програти</div>`;
          btn.addEventListener('click', ()=> speak(text));
          memeGrid.appendChild(btn);
        }
      }
      function escapeHtml(s){ return (s+'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      populatePhrasesGrid();

      // double-click memeGrid to add phrase
      memeGrid.addEventListener('dblclick', ()=> {
        const t = prompt('Введи нову фразу для мем-зони:');
        if (t && t.trim()){
          userPhrases.unshift(t.trim());
          localStorage.setItem('iba_user_phrases', JSON.stringify(userPhrases));
          phrases = userPhrases.concat(phrases.filter(p => !userPhrases.includes(p)));
          populatePhrasesGrid();
          alert('Фраза збережена.');
        }
      });

      addPhraseBtn.addEventListener('click', ()=> {
        const v = (newPhraseInput.value||'').trim();
        if (!v) return alert('Введи фразу.');
        userPhrases.unshift(v);
        localStorage.setItem('iba_user_phrases', JSON.stringify(userPhrases));
        phrases = userPhrases.concat(phrases.filter(p => !userPhrases.includes(p)));
        newPhraseInput.value = '';
        populatePhrasesGrid();
      });

      clearUserPhrases.addEventListener('click', ()=> {
        if (!confirm('Очистити усі користувацькі фрази?')) return;
        userPhrases = [];
        localStorage.removeItem('iba_user_phrases');
        phrases = [
          "Іба чотко!",
          "Чотко і без компромісів",
          "Коли все ясно — іба чотко",
          "Звучить як план: іба чотко",
          "Прокачай на 100%: іба чотко",
          "Котрий раз говорю — іба чотко!"
        ];
        populatePhrasesGrid();
      });

      // -- TTS --
      let voices = [];
      function loadVoices(){
        voices = speechSynthesis.getVoices().sort((a,b)=>a.name.localeCompare(b.name));
        voiceSelect.innerHTML = '';
        if (!voices.length){
          const o = document.createElement('option'); o.textContent = 'Голосів не знайдено'; voiceSelect.appendChild(o); voiceSelect.disabled = true;
        } else {
          voiceSelect.disabled = false;
          voices.forEach(v=>{
            const opt = document.createElement('option'); opt.value = v.name; opt.textContent = `${v.name} — ${v.lang}`; voiceSelect.appendChild(opt);
          });
          const uk = voices.find(v=>/uk|uk-UA/i.test(v.lang)) || voices.find(v=>/ru|ru-RU/i.test(v.lang)) || voices[0];
          if (uk) voiceSelect.value = uk.name;
        }
      }
      if ('speechSynthesis' in window){
        loadVoices();
        window.speechSynthesis.onvoiceschanged = loadVoices;
      } else {
        voiceSelect.innerHTML = '<option>Web Speech API не підтримується</option>';
        voiceSelect.disabled = true;
      }

      function speak(text){
        if (!text) return;
        if ('speechSynthesis' in window){
          try {
            speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.rate = parseFloat(rateInput.value) || 1;
            const sel = voiceSelect.value;
            if (voices.length && sel){
              const v = voices.find(x=>x.name===sel);
              if (v) u.voice = v;
            }
            speechSynthesis.speak(u);
          } catch(e){
            console.warn(e);
            alert(text);
          }
        } else {
          alert(text);
        }
      }
      playRandomBtn.addEventListener('click', ()=> speak(phrases[Math.floor(Math.random()*phrases.length)]));

      // quick TTS button on home
      document.getElementById('playIbaMain').addEventListener('click', ()=> speak('Іба чотко!'));

      // -- Meme generation (async to wait for logo image load) --
      function wrapText(ctx, text, x, y, maxWidth, lineHeight){
        const words = text.split(' ');
        let line = ''; const lines = [];
        for (let n=0;n<words.length;n++){
          const testLine = line + words[n] + ' ';
          const metrics = ctx.measureText(testLine);
          if (metrics.width > maxWidth && n > 0) { lines.push(line.trim()); line = words[n] + ' '; } else { line = testLine; }
        }
        if (line) lines.push(line.trim());
        const totalHeight = lines.length * lineHeight;
        let startY = y - totalHeight/2 + lineHeight/2;
        lines.forEach((ln,i)=>{
          ctx.lineWidth = Math.max(6, lineHeight/12);
          ctx.strokeStyle = 'rgba(0,0,0,0.6)';
          ctx.strokeText(ln, x, startY + i*lineHeight);
          ctx.fillText(ln, x, startY + i*lineHeight);
        });
      }

      async function generateMemeImage(topText, bottomText){
        const W = 1200, H = 1200;
        canvas.width = W; canvas.height = H;
        // background gradient
        const g = ctx.createLinearGradient(0,0,W,H);
        g.addColorStop(0,'#0b1020'); g.addColorStop(1,'#171432');
        ctx.fillStyle = g; ctx.fillRect(0,0,W,H);

        // draw uploadedImage if present
        if (uploadedImage){
          const img = uploadedImage;
          const scale = Math.max(W/img.width, H/img.height) * 0.95;
          const iw = img.width * scale, ih = img.height * scale;
          const ix = (W - iw)/2, iy = (H - ih)/2;
          ctx.drawImage(img, ix, iy, iw, ih);
          ctx.fillStyle = 'rgba(0,0,0,0.18)';
          ctx.fillRect(0,0,W,H);
        } else {
          // draw stylized mascot circle
          ctx.save();
          ctx.translate(W/2, H/2 - 60);
          ctx.beginPath(); ctx.arc(0,0,360,0,Math.PI*2); ctx.fillStyle = 'rgba(255,59,107,0.06)'; ctx.fill();
          const lg = ctx.createLinearGradient(-300,-300,300,300); lg.addColorStop(0,'#ff3b6b'); lg.addColorStop(1,'#ffd23f');
          ctx.beginPath(); ctx.arc(0,0,260,0,Math.PI*2); ctx.fillStyle = lg; ctx.fill();
          ctx.fillStyle = '#071025'; ctx.beginPath(); ctx.arc(-40,-10,40,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(40,-10,40,0,Math.PI*2); ctx.fill();
          ctx.strokeStyle = '#071025'; ctx.lineWidth = 16; ctx.beginPath(); ctx.moveTo(-60,70); ctx.quadraticCurveTo(0,110,60,70); ctx.stroke();
          ctx.restore();
        }

        // draw logo if stored
        if (storedLogoDataUrl){
          await new Promise(resolve => {
            const l = new Image();
            l.onload = () => {
              const maxW = 220, maxH = 90;
              let lw = l.width, lh = l.height;
              const s = Math.min(maxW/lw, maxH/lh, 1);
              lw *= s; lh *= s;
              ctx.globalAlpha = 0.96;
              ctx.drawImage(l, 40, H - lh - 40, lw, lh);
              ctx.globalAlpha = 1;
              resolve();
            };
            l.onerror = () => resolve();
            l.src = storedLogoDataUrl;
          });
        }

        // Texts
        ctx.fillStyle = '#fff'; ctx.textAlign = 'center';
        ctx.font = 'bold 64px "Segoe UI", Roboto, Arial';
        wrapText(ctx, (topText||'').toUpperCase(), W/2, 120, W - 140, 64);

        ctx.fillStyle = '#ffd23f';
        ctx.font = 'bold 58px "Segoe UI", Roboto, Arial';
        wrapText(ctx, (bottomText||'').toUpperCase(), W/2, H - 120, W - 140, 58);

        // branding footer
        ctx.globalAlpha = 0.95;
        ctx.fillStyle = '#fff';
        ctx.font = '700 18px "Segoe UI", Roboto, Arial';
        ctx.textAlign = 'right';
        ctx.fillText('Іба Чотко • Головнін В.С.', W - 40, H - 24);
        ctx.globalAlpha = 1;

        return canvas.toDataURL('image/png');
      }

      generateMemeBtn.addEventListener('click', async ()=>{
        const top = topTextInput.value.trim() || phrases[Math.floor(Math.random()*phrases.length)];
        const bottom = bottomTextInput.value.trim() || 'Іба Чотко';
        try {
          const dataUrl = await generateMemeImage(top, bottom);
          lastMemeDataUrl = dataUrl;
          lastMemePreview.innerHTML = '';
          const img = document.createElement('img'); img.src = dataUrl; lastMemePreview.appendChild(img);
          alert('Мем згенеровано — можна завантажити або відкрити в новій вкладці.');
        } catch (e) {
          console.error(e); alert('Помилка при генерації мему. Спробуйте інше зображення або перезавантажте сторінку.');
        }
      });

      downloadMemeBtn.addEventListener('click', ()=>{
        if (!lastMemeDataUrl) return alert('Спочатку згенеруйте мем.');
        const a = document.createElement('a'); a.href = lastMemeDataUrl; a.download = 'iba-chotko-meme.png'; document.body.appendChild(a); a.click(); a.remove();
      });

      openMemeBtn.addEventListener('click', ()=>{
        if (!lastMemeDataUrl) return alert('Спочатку згенеруйте мем.');
        const w = window.open('');
        if (w){
          w.document.title = 'Мем — Іба Чотко';
          w.document.body.style.background = '#071025';
          w.document.body.style.margin = '0';
          const im = w.document.createElement('img'); im.src = lastMemeDataUrl; im.style.maxWidth = '100%'; w.document.body.appendChild(im);
        } else alert('Попап заблоковано — дозволь відкриття вікон.');
      });

      // -- Copy URL & share --
      copyUrlBtn.addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(location.href);
          copyUrlBtn.textContent = 'Скопійовано!';
          setTimeout(()=> copyUrlBtn.textContent = 'Копіювати URL', 1400);
        } catch {
          alert('Не вдалося скопіювати URL. Скопіюй вручну.');
        }
      });
      function updateShareLink(){
        const txt = encodeURIComponent('Іба Чотко — офіційний мем-сайт!');
        const url = encodeURIComponent(location.href);
        tweetShare.href = `https://twitter.com/intent/tweet?text=${txt}&url=${url}`;
      }
      updateShareLink();

      // -- keyboard shortcuts --
      document.addEventListener('keydown', (e)=>{
        if (e.code === 'Space' && !/input|textarea/i.test(document.activeElement.tagName)) { e.preventDefault(); speak('Іба чотко!'); }
        if (e.key.toLowerCase() === 'g') { e.preventDefault(); activateTab('studio'); generateMemeBtn.click(); }
        if (e.key.toLowerCase() === 'l') { e.preventDefault(); logoArea.focus(); }
      });

      // -- theme toggle (simple invert for demonstration) --
      let dark = true;
      themeBtn.addEventListener('click', ()=>{
        dark = !dark;
        if (dark){
          document.documentElement.style.setProperty('--bg-1','#030417'); document.documentElement.style.setProperty('--bg-2','#07112a');
        } else {
          document.documentElement.style.setProperty('--bg-1','#f7f8fb'); document.documentElement.style.setProperty('--bg-2','#e9ecf5');
          document.documentElement.style.setProperty('--accent-1','#2b6cff'); document.documentElement.style.setProperty('--accent-2','#3df5b8');
          document.body.style.color = '#081018';
        }
      });

      // -- Export ZIP (basic generation of text files packaged as zip via JS) --
      downloadZipBtn.addEventListener('click', ()=>{
        // produce a minimal ZIP using JS-only approach (create files and offer them as .zip is complex without library)
        // Instead we produce a single downloadable HTML snapshot of the current site panel (user can save it).
        const curTab = Array.from(tabs).find(t => t.getAttribute('aria-selected') === 'true');
        const curPanel = document.getElementById(curTab.dataset.target);
        const html = `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Snapshot - ${escapeHtml(curTab.textContent)}</title><style>body{background:#071025;color:#fff;font-family:Arial;padding:18px}.card{background:#0f1936;padding:16px;border-radius:12px}</style></head><body><div class="card">${escapeHtml(curPanel.innerHTML)}</div></body></html>`;
        const blob = new Blob([html], {type:'text/html'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'iba-chotko-panel-snapshot.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      });

      // -- Initial render & diagnostics --
      renderLogo();
      populatePhrasesGrid();

      // set preview if previously uploaded image stored in session (we don't persist image blob)
      // log
      console.log('Іба Чотко сайт ініціалізовано — всі основні модулі завантажені.');
    })();
  </script>
</body>
</html>
